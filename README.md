# SFTMD-PyTorch

### Overview

This repository contains an op-for-op PyTorch reimplementation of [Blind Super-Resolution With Iterative Kernel Correction](https://arxiv.org/abs/1904.03377v2).

### Table of contents

- [SFTMD-PyTorch](#sftmd-pytorch)
    - [Overview](#overview)
    - [Table of contents](#table-of-contents)
    - [About Blind Super-Resolution With Iterative Kernel Correction](#about-blind-super-resolution-with-iterative-kernel-correction)
    - [Download weights](#download-weights)
    - [Download datasets](#download-datasets)
    - [Test](#test)
    - [Train](#train)
    - [Result](#result)
    - [Credit](#credit)
        - [Blind Super-Resolution With Iterative Kernel Correction](#blind-super-resolution-with-iterative-kernel-correction)

## About Blind Super-Resolution With Iterative Kernel Correction

If you're new to SFTMD, here's an abstract straight from the paper:

Deep learning based methods have dominated super-resolution (SR) field due to their remarkable performance in terms of effectiveness and efficiency.
Most of these methods assume that the blur kernel during downsampling is predefined/known (e.g., bicubic). However, the blur kernels involved in real
applications are complicated and unknown, resulting in severe performance drop for the advanced SR methods. In this paper, we propose an Iterative
Kernel Correction (IKC) method for blur kernel estimation in blind SR problem, where the blur kernels are unknown. We draw the observation that kernel
mismatch could bring regular artifacts (either over-sharpening or over-smoothing), which can be applied to correct inaccurate blur kernels. Thus we
introduce an iterative correction scheme -- IKC that achieves better results than direct kernel estimation. We further propose an effective SR network
architecture using spatial feature transform (SFT) layers to handle multiple blur kernels, named SFTMD. Extensive experiments on synthetic and
real-world images show that the proposed IKC method with SFTMD can provide visually favorable SR results and the state-of-the-art performance in blind
SR problem.

## Download weights

- [Google Driver](https://drive.google.com/drive/folders/17ju2HN7Y6pyPK2CC_AqnAfTOe9_3hCQ8?usp=sharing)
- [Baidu Driver](https://pan.baidu.com/s/1yNs4rqIb004-NKEdKBJtYg?pwd=llot)

## Download datasets

Contains DIV2K, DIV8K, Flickr2K, OST, T91, Set5, Set14, BSDS100 and BSDS200, etc.

- [Google Driver](https://drive.google.com/drive/folders/1A6lzGeQrFMxPqJehK9s37ce-tPDj20mD?usp=sharing)
- [Baidu Driver](https://pan.baidu.com/s/1o-8Ty_7q6DiS3ykLU09IVg?pwd=llot)

## Test

Modify the contents of the `config.py` file as follows.

- line 29: `upscale_factor` change to the magnification you need to enlarge.
- line 31: `mode` change to `valid`.
- line 35: `pca_matrix_path` change PCA matrix file address generated by `create_pca_matrix.py` in scripts directory (recommended do not change).
- line 37: `kernel_size` change gaussian blur kernel size (recommended do not change).
- line 39: `sigma` change gaussian blur sigma value (recommended do not change).
- line 41: `min_sigma` change gaussian blur min sigma value (recommended do not change).
- line 43: `max_sigma` change gaussian blur max sigma value (recommended do not change).
- line 81: `model_path` change weight address after training.

## Train

Modify the contents of the `config.py` file as follows.

- line 29: `upscale_factor` change to the magnification you need to enlarge.
- line 31: `mode` change Set to train mode.
- line 35: `pca_matrix_path` change PCA matrix file address generated by `create_pca_matrix.py` in scripts directory (recommended do not change).
- line 37: `kernel_size` change gaussian blur kernel size (recommended do not change).
- line 39: `sigma` change gaussian blur sigma value (recommended do not change).
- line 41: `min_sigma` change gaussian blur min sigma value (recommended do not change).
- line 43: `max_sigma` change gaussian blur max sigma value (recommended do not change).

If you want to load weights that you've trained before, modify the contents of the file as follows.

### Resume model

Modify the contents of the `config.py` file as follows.

- line 58: `start_epoch` change number of model training iterations in the previous round.
- line 59: `resume` change to SRResNet model address that needs to be loaded.

## Result

Source of original paper results: https://arxiv.org/pdf/1904.03377v2.pdf

In the following table, the value in `()` indicates the result of the project, and `-` indicates no test.

| Dataset | Scale |     PSNR     |
|:-------:|:-----:|:------------:|
|  Set5   |   2   | 36.62(**-**) |
|  Set5   |   3   | 32.16(**-**) |
|  Set5   |   4   | 31.52(**-**) |

Low Resolution / Super Resolution / High Resolution
<span align="center"><img src="assets/result.png"/></span>

### Credit

#### Blind Super-Resolution With Iterative Kernel Correction

_Jinjin Gu, Hannan Lu, Wangmeng Zuo, Chao Dong_ <br>

**Abstract** <br>
Deep learning based methods have dominated super-resolution (SR) field due to their remarkable performance in terms of effectiveness and efficiency.
Most of these methods assume that the blur kernel during downsampling is predefined/known (e.g., bicubic). However, the blur kernels involved in real
applications are complicated and unknown, resulting in severe performance drop for the advanced SR methods. In this paper, we propose an Iterative
Kernel Correction (IKC) method for blur kernel estimation in blind SR problem, where the blur kernels are unknown. We draw the observation that kernel
mismatch could bring regular artifacts (either over-sharpening or over-smoothing), which can be applied to correct inaccurate blur kernels. Thus we
introduce an iterative correction scheme -- IKC that achieves better results than direct kernel estimation. We further propose an effective SR network
architecture using spatial feature transform (SFT) layers to handle multiple blur kernels, named SFTMD. Extensive experiments on synthetic and
real-world images show that the proposed IKC method with SFTMD can provide visually favorable SR results and the state-of-the-art performance in blind
SR problem.

[[Code(PyTorch)]](https://github.com/yuanjunchai/IKC) [[Paper]](https://arxiv.org/pdf/1904.03377v2.pdf)

```
@InProceedings{gu2019blind,
    author = {Gu, Jinjin and Lu, Hannan and Zuo, Wangmeng and Dong, Chao},
    title = {Blind super-resolution with iterative kernel correction},
    booktitle = {The IEEE Conference on Computer Vision and Pattern Recognition (CVPR)},
    month = {June},
    year = {2019}
}
```
